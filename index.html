<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fight Me</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible+Next:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Atkinson Hyperlegible Next"', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

    <style>
        :root {
            --background-color: #0c1a2c; /* Dark Blue/Slate */
            --surface-color: #1a2a3c;   /* Slightly lighter surface */
            --accent-color: #f59e0b;      /* Amber */
            --text-color: #ffffffde;
            --work-color: #f59e0b;      
            --rest-color: #10b981;      
            --warn-color: #fcd34d;      
        }
        body {
            font-family: 'Atkinson Hyperlegible Next', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        #timer-display {
            font-size: clamp(3.5rem, 18vw, 9rem); 
            line-height: 1;
            font-weight: 900;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.2); 
            transition: text-shadow 0.5s ease, color 0.5s ease;
            text-align: center;
            letter-spacing: -0.05em;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--surface-color); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Style the select dropdown */
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25rem 1.25rem;
        }
        
        /* Volume Slider Customization */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent-color);
            cursor: pointer;
            border-radius: 50%;
            margin-top: -5px; 
            box-shadow: 0 0 5px rgba(245, 158, 11, 0.6);
            transition: background 0.2s;
        }
        input[type=range]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: var(--accent-color);
            cursor: pointer;
            border-radius: 50%;
            border: none;
            box-shadow: 0 0 5px rgba(245, 158, 11, 0.6);
            transition: background 0.2s;
        }
        input[type=range]::-webkit-slider-runnable-track {
            height: 4px;
            background: #475569;
            border-radius: 2px;
        }
        input[type=range]::-moz-range-track {
            height: 4px;
            background: #475569;
            border-radius: 2px;
        }

        /* Confetti Container Styling */
        #confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 60;
        }

        /* Basic Confetti Particle Style (CSS only for simplicity) */
        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--accent-color);
            opacity: 0;
            animation: pop 2.5s ease-out forwards;
        }

        @keyframes pop {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0.5; }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 font-sans">

    <div id="confetti-container"></div>
    
    <div id="app" class="w-full max-w-sm sm:max-w-2xl bg-[--surface-color] shadow-2xl rounded-2xl p-6 sm:p-8 space-y-6 border border-slate-700">
        
        <header class="text-center flex justify-between items-center">
            <div class="w-1/5"></div> <div class="flex-grow">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-white tracking-wide">Fight Me</h1>
                <p id="workout-name" class="text-lg sm:text-xl text-slate-400 mt-1">A boxing training app</p>
            </div>
            <div class="w-1/5 flex justify-end">
                <button id="fullscreen-btn" title="Toggle Fullscreen"
                    class="p-2.5 bg-slate-700 hover:bg-slate-600 rounded-full text-white transition duration-150 active:scale-95">
                    <i data-lucide="maximize" class="w-6 h-6" id="fullscreen-icon"></i>
                </button>
            </div>
        </header>

        <div id="combo-callout" class="text-center text-2xl sm:text-3xl text-amber-500 font-extrabold min-h-[50px] p-3 bg-slate-700/50 rounded-lg shadow-inner flex items-center justify-center">
            <span class="text-slate-400 text-base">Press Start to begin training!</span>
        </div>

        <div class="text-center py-2 space-y-2">
            <div id="total-time-display" class="text-lg text-slate-400 font-semibold tabular-nums">
                Total Remaining: 00:00
            </div>
            <div id="timer-display" class="font-extrabold text-white tracking-tighter tabular-nums transition-colors duration-500">
                03:00
            </div>
        </div>
        
        <div class="space-y-4">
            <div id="config-card" class="bg-slate-700 rounded-xl p-4 sm:p-6 space-y-6 shadow-xl opacity-100 transition-opacity duration-300">
                
                <div class="space-y-3 border-b border-slate-600 pb-4">
                    <h3 class="text-xl font-bold text-amber-400">Timer Settings</h3>
                    <div class="grid grid-cols-3 gap-3 sm:gap-4">
                        <div class="space-y-1">
                            <label for="round-duration" class="text-xs font-semibold text-slate-300 block">Round Mins</label>
                            <input type="number" id="round-duration" value="3" min="1"
                                class="w-full bg-slate-800 text-white p-2 rounded-lg border-2 border-slate-600 focus:border-amber-500 transition duration-150 text-center">
                        </div>
                        <div class="space-y-1">
                            <label for="rest-duration" class="text-xs font-semibold text-slate-300 block">Rest Mins</label>
                            <input type="number" id="rest-duration" value="1" min="0"
                                class="w-full bg-slate-800 text-white p-2 rounded-lg border-2 border-slate-600 focus:border-amber-500 transition duration-150 text-center">
                        </div>
                        <div class="space-y-1">
                            <label for="num-rounds" class="text-xs font-semibold text-slate-300 block">Total Rounds</label>
                            <input type="number" id="num-rounds" value="5" min="1"
                                class="w-full bg-slate-800 text-white p-2 rounded-lg border-2 border-slate-600 focus:border-amber-500 transition duration-150 text-center">
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="text-xl font-bold text-amber-400">Combo Logic Settings</h3>

                    <div class="space-y-2">
                        <label for="combo-length-slider" class="text-sm font-semibold text-slate-300 block">1. Combo Length <span id="length-label" class="text-amber-300 ml-2 text-xs font-normal">Medium (1-4 Punches)</span></label>
                        <input type="range" id="combo-length-slider" min="0" max="2" value="1" step="1"
                            class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <div class="flex justify-between text-xs text-slate-400 pt-1">
                            <span>Low</span><span>Medium</span><span>High</span>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label for="combo-difficulty-slider" class="text-sm font-semibold text-slate-300 block">2. Combo Difficulty <span id="difficulty-label" class="text-amber-300 ml-2 text-xs font-normal">Medium (Some Same-Side)</span></label>
                        <input type="range" id="combo-difficulty-slider" min="0" max="2" value="1" step="1"
                            class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <div class="flex justify-between text-xs text-slate-400 pt-1">
                            <span>Low</span><span>Medium</span><span>High</span>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label for="move-complexity-slider" class="text-sm font-semibold text-slate-300 block">3. Move Complexity <span id="complexity-label" class="text-amber-300 ml-2 text-xs font-normal">Medium (Occasional Non-Punches)</span></label>
                        <input type="range" id="move-complexity-slider" min="0" max="2" value="1" step="1"
                            class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <div class="flex justify-between text-xs text-slate-400 pt-1">
                            <span>Low</span><span>Medium</span><span>High</span>
                        </div>
                    </div>
                </div>

                <div class="space-y-4 border-t border-slate-600 pt-4">
                    <h3 class="text-xl font-bold text-amber-400">Audio & Control Settings</h3>
                    
                    <div class="grid grid-cols-2 gap-4"> 
                        <div class="space-y-1">
                            <label for="combo-repetitions-select" class="text-xs font-semibold text-slate-300 block">4. Combo Intensity</label>
                            <select id="combo-repetitions-select"
                                class="w-full bg-slate-800 text-white p-2 rounded-lg border-2 border-slate-600 focus:border-amber-500 transition duration-150 appearance-none pr-10">
                                <option value="1">Low (1x Repetition)</option>
                                <option value="2">Medium (2x Repetitions)</option>
                                <option value="3" selected>High (3x Repetitions)</option>
                            </select>
                        </div>

                        <div class="space-y-1">
                            <label for="voice-volume-slider" class="text-xs font-semibold text-slate-300 block">5. Voice Volume (<span id="voice-volume-label">100%</span>)</label>
                            <input type="range" id="voice-volume-slider" min="0" max="1" step="0.05" value="1"
                                class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        </div>
                    </div> 
                </div>
            </div>
            
            <div id="info-card" class="bg-slate-700 rounded-xl p-4 sm:p-6 space-y-4 shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none absolute inset-0 sm:relative sm:inset-auto sm:pointer-events-auto">
                
                <div class="flex justify-between items-center pb-2 border-b border-slate-600">
                    <div class="text-xl font-bold text-white">Round Progress</div>
                    <div class="text-lg font-semibold text-amber-300">Round <span id="current-round">1</span> / <span id="total-rounds">5</span></div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="p-4 bg-slate-800 rounded-lg">
                        <div class="text-xs font-semibold text-slate-400 uppercase">Phase</div>
                        <div id="phase-display" class="text-2xl font-extrabold text-amber-400 mt-1">Work</div>
                    </div>
                    <div class="p-4 bg-slate-800 rounded-lg">
                        <div class="text-xs font-semibold text-slate-400 uppercase">Next Callout In</div>
                        <div id="combo-countdown" class="text-2xl font-extrabold text-white mt-1 tabular-nums">0s</div>
                    </div>
                </div>

                <div class="pt-2 border-t border-slate-600">
                    <h4 class="text-lg font-bold text-slate-300 mb-2">Last Callout:</h4>
                    <p id="last-combo-display" class="text-base text-slate-400 font-mono italic">--</p>
                </div>
            </div>
            
            <div id="controls" class="flex flex-col space-y-3 pt-2">
                <button id="start-btn" 
                    class="w-full p-4 bg-amber-500 hover:bg-amber-600 text-slate-900 text-xl font-bold rounded-xl shadow-lg transition duration-150 active:scale-95 flex items-center justify-center space-x-2">
                    <i data-lucide="play" class="w-6 h-6"></i>
                    <span>START ROUNDS</span>
                </button>
                <div class="flex space-x-3">
                    <button id="pause-btn" disabled 
                        class="flex-grow p-3 bg-slate-600 hover:bg-slate-500 text-white font-semibold rounded-xl transition duration-150 active:scale-95 opacity-50 cursor-not-allowed flex items-center justify-center space-x-2">
                        <i data-lucide="pause" class="w-5 h-5"></i>
                        <span>Pause</span>
                    </button>
                    <button id="reset-btn" 
                        class="flex-grow p-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition duration-150 active:scale-95 flex items-center justify-center space-x-2">
                        <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                        <span>Reset</span>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE MANAGEMENT ---
        let timer = null;
        let config = {};
        let state = {
            isRunning: false,
            isPaused: false,
            isWorkPhase: true,
            currentRound: 1,
            timeRemaining: 0,
            totalTimeRemaining: 0,
            comboTimeout: null,
            nextComboTime: 0,
        };
        let sounds = {};
        let selectedVoice = null;

        // --- DOM ELEMENTS ---
        const DOMElements = {
            timerDisplay: document.getElementById('timer-display'),
            totalTimeDisplay: document.getElementById('total-time-display'),
            startBtn: document.getElementById('start-btn'),
            pauseBtn: document.getElementById('pause-btn'),
            resetBtn: document.getElementById('reset-btn'),
            roundDurationInput: document.getElementById('round-duration'),
            restDurationInput: document.getElementById('rest-duration'),
            numRoundsInput: document.getElementById('num-rounds'),
            currentRoundDisplay: document.getElementById('current-round'),
            totalRoundsDisplay: document.getElementById('total-rounds'),
            phaseDisplay: document.getElementById('phase-display'),
            comboCallout: document.getElementById('combo-callout').querySelector('span'),
            lastComboDisplay: document.getElementById('last-combo-display'),
            comboCountdown: document.getElementById('combo-countdown'),
            configCard: document.getElementById('config-card'),
            infoCard: document.getElementById('info-card'),
            comboLengthSlider: document.getElementById('combo-length-slider'),
            comboDifficultySlider: document.getElementById('combo-difficulty-slider'),
            moveComplexitySlider: document.getElementById('move-complexity-slider'),
            comboRepetitionsSelect: document.getElementById('combo-repetitions-select'),
            voiceVolumeSlider: document.getElementById('voice-volume-slider'),
            lengthLabel: document.getElementById('length-label'),
            difficultyLabel: document.getElementById('difficulty-label'),
            complexityLabel: document.getElementById('complexity-label'),
            voiceVolumeLabel: document.getElementById('voice-volume-label'),
            fullscreenBtn: document.getElementById('fullscreen-btn'),
            fullscreenIcon: document.getElementById('fullscreen-icon'),
        };
        
        // --- PUNCH & MOVE DATA ---
        const punchMoves = {
            '1': { name: 'Jab', side: 'left' },
            '2': { name: 'Cross', side: 'right' },
            '3': { name: 'Lead Hook', side: 'left' },
            '4': { name: 'Rear Hook', side: 'right' },
            '5': { name: 'Lead Uppercut', side: 'left' },
            '6': { name: 'Rear Uppercut', side: 'right' },
            '1b': { name: 'Jab to the Body', side: 'left' },
            '2b': { name: 'Cross to the Body', side: 'right' },
            '3b': { name: 'Lead Hook to the Body', side: 'left' },
            '4b': { name: 'Rear Hook to the Body', side: 'right' },
            'slip left': { name: 'Slip Left', side: 'defense' },
            'slip right': { name: 'Slip Right', side: 'defense' },
            'roll left': { name: 'Roll Left', side: 'defense' },
            'roll right': { name: 'Roll Right', side: 'defense' },
            'block lead': { name: 'Block Lead', side: 'defense' },
            'block rear': { name: 'Block Rear', side: 'defense' },
        };
        
        const punchKeys = ['1', '2', '3', '4', '5', '6', '1b', '2b', '3b', '4b'];
        const defensiveMovesAfterLeft = ['slip left', 'roll left', 'block rear'];
        const defensiveMovesAfterRight = ['slip right', 'roll right', 'block lead'];

        // --- TEXT-TO-SPEECH ---
        function loadVoices() {
            const allVoices = speechSynthesis.getVoices();
            if (!allVoices.length) return;

            const platform = navigator.userAgent;
            let preferredVoices = [];

            if (/Mac/i.test(platform)) {
                preferredVoices = ['Samantha', 'Victoria', 'Ava'];
            } else if (/Win/i.test(platform)) {
                preferredVoices = ['Zira'];
            } else if (/Android/i.test(platform)) {
                preferredVoices = allVoices
                    .filter(v => v.lang.startsWith('en') && /female/i.test(v.name) && !/network/i.test(v.name))
                    .map(v => v.name);
            }

            for (const name of preferredVoices) {
                const voice = allVoices.find(v => v.name === name && v.lang.startsWith('en'));
                if (voice) {
                    selectedVoice = voice;
                    return;
                }
            }
            selectedVoice = allVoices.find(v => v.lang.startsWith('en') && /female/i.test(v.name)) || allVoices.find(v => v.lang.startsWith('en'));
        }

        function speak(text) {
            if (!selectedVoice || !text) return;
            if (Tone.context.state !== 'running') {
                Tone.context.resume();
            }
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text.replace(/-/g, ', '));
            utterance.voice = selectedVoice;
            utterance.volume = config.voiceVolume;
            utterance.rate = 1.1;
            utterance.pitch = 0.9;
            speechSynthesis.speak(utterance);
        }

        // --- SOUND EFFECTS ---
        function initializeSounds() {
            DOMElements.startBtn.disabled = true;
            const startBtnSpan = DOMElements.startBtn.querySelector('span');
            if(startBtnSpan) startBtnSpan.textContent = 'LOADING SOUNDS...';

            // Fresh, valid Base64 data for sounds
            const soundData = {
                gong: 'data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA1B0AAANIAAAAhhhBAAgykAlJKkIBAAAB28AAAAC6QAAB6wYxBTirDEU0s+cnJxDT5ycjDVrYynIsynIwy8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//tAwR/8AAGtA//uCukA3k//3/y484sAADu0AAAAvsAAD/0IAD/0gA5B/9/8uPOPAAAAAAALsAAAD/0gA/+CAH//5EJEJDZAa//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//AAMHFAADSAAAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV-..',
                warn: 'data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA1B0AAANIAAAAhhhBAAgykAlJKkIBAAAB28AAAAC6QAAB6wYxBTirDEU0s+cnJxDT5ycjDVrYynIsynIwy8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//tAwR/8AAGtA//uCukA3k//3/y484sAADu0AAAAvsAAD/0IAD/0gA5B/9/8uPOPAAAAAAALsAAAD/0gA/+CAH//5EJEJDZAa//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//-..',
                end: 'data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA1B0AAANIAAAAhhhBAAgykAlJKkIBAAAB28AAAAC6QAAB6wYxBTirDEU0s+cnJxDT5ycjDVrYynIsynIwy8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//tAwR/8AAGtA//uCukA3k//3/y484sAADu0AAAAvsAAD/0IAD/0gA5B/9/8uPOPAAAAAAALsAAAD/0gA/+CAH//5EJEJDZAa//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8A//8-..'
            };

            const players = new Tone.Players(soundData, () => {
                sounds = players.toDestination();
                if(startBtnSpan) startBtnSpan.textContent = 'START ROUNDS';
                DOMElements.startBtn.disabled = false;
            }).toDestination();

            players.volume.value = -3; // Lower volume slightly
        }

        function playSound(sound) {
            if (sounds && sounds.player(sound)) {
                if (Tone.context.state !== 'running') {
                    Tone.context.resume().then(() => {
                        sounds.player(sound).start();
                    });
                } else {
                    sounds.player(sound).start();
                }
            }
        }

        // --- CORE TIMER LOGIC ---
        function startTimer() {
            if (state.isRunning && !state.isPaused) return;

            if (state.isPaused) {
                state.isPaused = false;
                state.isRunning = true;
                if (state.isWorkPhase) {
                    comboLoop();
                }
            } else {
                updateConfig();
                state.currentRound = 1;
                state.totalTimeRemaining = (config.roundDuration + config.restDuration) * config.numRounds - config.restDuration;
                startRound();
            }
            
            if (!timer) {
                timer = setInterval(timerTick, 1000);
            }

            updateUIForState();
        }

        function pauseTimer() {
            state.isPaused = true;
            state.isRunning = false;
            clearTimeout(state.comboTimeout);
            updateUIForState();
        }
        
        function resetTimer() {
            clearInterval(timer);
            timer = null;
            clearTimeout(state.comboTimeout);
            state = { ...state, isRunning: false, isPaused: false, currentRound: 1 };
            updateConfig();
            updateUIForState();
            DOMElements.comboCallout.innerHTML = `<span class="text-slate-400 text-base">Press Start to begin training!</span>`;
            DOMElements.lastComboDisplay.textContent = '--';
        }

        function timerTick() {
            if (state.isPaused || !state.isRunning) return;

            state.timeRemaining--;
            state.totalTimeRemaining--;

            if (state.isWorkPhase) {
                const comboCountdownTime = Math.ceil((state.nextComboTime - Date.now()) / 1000);
                DOMElements.comboCountdown.textContent = `${Math.max(0, comboCountdownTime)}s`;
                if (state.timeRemaining === 10) playSound('warn');
            }

            updateTimerDisplays();

            if (state.timeRemaining <= 0) {
                if (state.isWorkPhase) {
                    if (state.currentRound < config.numRounds) {
                        startRest();
                    } else {
                        workoutComplete();
                    }
                } else {
                    state.currentRound++;
                    startRound();
                }
            }
        }

        function startRound() {
            clearTimeout(state.comboTimeout);
            playSound('gong');
            
            state.isWorkPhase = true;
            state.isRunning = true;
            state.isPaused = false;
            state.timeRemaining = config.roundDuration;
            
            updateUIForState();
            updateTimerDisplays();
            DOMElements.comboCallout.innerHTML = `Round ${state.currentRound}! Fight!`;
            speak(`Round ${state.currentRound}`);

            // Start combos after a short delay
            state.comboTimeout = setTimeout(comboLoop, 2000);
            state.nextComboTime = Date.now() + 2000;
        }
        
        function startRest() {
            clearTimeout(state.comboTimeout);
            playSound('end');

            state.isWorkPhase = false;
            state.timeRemaining = config.restDuration;

            updateUIForState();
            updateTimerDisplays();
            DOMElements.comboCallout.innerHTML = 'Rest';
            speak('Rest');
        }

        function workoutComplete() {
            clearInterval(timer);
            timer = null;
            clearTimeout(state.comboTimeout);
            playSound('end');
            speak('Workout complete. Great job!');
            DOMElements.comboCallout.innerHTML = 'Workout Complete!';
            launchConfetti();
            setTimeout(resetTimer, 4000);
        }

        // --- COMBO GENERATION ---
        function comboLoop() {
            if (!state.isRunning || state.isPaused || !state.isWorkPhase) {
                return;
            }

            const combo = generateCombo();
            const comboText = combo.join('-');
            const comboName = combo.map(p => punchMoves[p].name).join(', ');

            const repetitions = config.comboRepetitions;
            let fullUtterance = [];
            for (let i = 0; i < repetitions; i++) {
                fullUtterance.push(comboName);
            }
            speak(fullUtterance.join('. '));
            
            DOMElements.comboCallout.textContent = comboText;
            DOMElements.lastComboDisplay.textContent = comboText;

            const minTime = 4000 / (config.comboRepetitions); 
            const maxTime = 7000 / (config.comboRepetitions);
            const nextCallout = Math.random() * (maxTime - minTime) + minTime;

            state.nextComboTime = Date.now() + nextCallout;
            state.comboTimeout = setTimeout(comboLoop, nextCallout);
        }

        function generateCombo() {
            const lengthSettings = [[1,2], [1,4], [3,6]][config.comboLength];
            const difficultySettings = [0.05, 0.3, 0.8][config.comboDifficulty]; 
            const complexitySettings = [0.05, 0.25, 0.5][config.moveComplexity];

            const comboLength = Math.floor(Math.random() * (lengthSettings[1] - lengthSettings[0] + 1)) + lengthSettings[0];
            let combo = [];
            let lastPunchSide = null;

            for (let i = 0; i < comboLength; i++) {
                let nextMove;
                let availablePunches = [...punchKeys];

                if (lastPunchSide && Math.random() < complexitySettings) {
                    const defensiveOptions = (lastPunchSide === 'left') ? defensiveMovesAfterLeft : defensiveMovesAfterRight;
                    nextMove = defensiveOptions[Math.floor(Math.random() * defensiveOptions.length)];
                } else {
                    if (lastPunchSide && Math.random() > difficultySettings) {
                        availablePunches = availablePunches.filter(p => punchMoves[p].side !== lastPunchSide);
                    }
                    if (!availablePunches.length) availablePunches = punchKeys;
                    nextMove = availablePunches[Math.floor(Math.random() * availablePunches.length)];
                }
                
                combo.push(nextMove);
                lastPunchSide = punchMoves[nextMove].side !== 'defense' ? punchMoves[nextMove].side : lastPunchSide;
            }
            return combo;
        }


        // --- UI & CONFIG UPDATES ---
        function updateConfig() {
            config = {
                roundDuration: parseInt(DOMElements.roundDurationInput.value) * 60,
                restDuration: parseInt(DOMElements.restDurationInput.value) * 60,
                numRounds: parseInt(DOMElements.numRoundsInput.value),
                comboLength: parseInt(DOMElements.comboLengthSlider.value),
                comboDifficulty: parseInt(DOMElements.comboDifficultySlider.value),
                moveComplexity: parseInt(DOMElements.moveComplexitySlider.value),
                comboRepetitions: parseInt(DOMElements.comboRepetitionsSelect.value),
                voiceVolume: parseFloat(DOMElements.voiceVolumeSlider.value),
            };

            if (!state.isRunning) {
                state.timeRemaining = config.roundDuration;
                state.totalTimeRemaining = (config.roundDuration + config.restDuration) * config.numRounds - config.restDuration;
                updateTimerDisplays();
            }
            updateLabels();
        }

        function updateVoiceVolume() {
            config.voiceVolume = parseFloat(DOMElements.voiceVolumeSlider.value);
            DOMElements.voiceVolumeLabel.textContent = `${Math.round(config.voiceVolume * 100)}%`;
        }

        function updateLabels() {
            DOMElements.lengthLabel.textContent = ['Low (1-2 Punches)', 'Medium (1-4 Punches)', 'High (3-6 Punches)'][config.comboLength];
            DOMElements.difficultyLabel.textContent = ['Low (No Same-Side)', 'Medium (Some Same-Side)', 'High (Frequent Same-Side)'][config.comboDifficulty];
            DOMElements.complexityLabel.textContent = ['Low (Punches Only)', 'Medium (Occasional Defense)', 'High (Frequent Defense)'][config.moveComplexity];
            DOMElements.totalRoundsDisplay.textContent = config.numRounds;
        }

        function updateUIForState() {
            const isRunningAndNotPaused = state.isRunning && !state.isPaused;
            const isRunningOrPaused = state.isRunning || state.isPaused;

            DOMElements.startBtn.style.display = isRunningAndNotPaused ? 'none' : 'flex';
            DOMElements.pauseBtn.style.display = isRunningAndNotPaused ? 'flex' : 'none';

            DOMElements.pauseBtn.disabled = !isRunningAndNotPaused;
            DOMElements.pauseBtn.classList.toggle('opacity-50', !isRunningAndNotPaused);
            DOMElements.pauseBtn.classList.toggle('cursor-not-allowed', !isRunningAndNotPaused);
            
            DOMElements.configCard.style.opacity = isRunningOrPaused ? '0' : '1';
            DOMElements.configCard.style.pointerEvents = isRunningOrPaused ? 'none' : 'auto';
            DOMElements.infoCard.style.opacity = isRunningOrPaused ? '1' : '0';
            DOMElements.infoCard.style.pointerEvents = isRunningOrPaused ? 'auto' : 'none';

            if (state.isPaused) {
                DOMElements.startBtn.querySelector('i').setAttribute('data-lucide', 'play');
                DOMElements.startBtn.querySelector('span').textContent = 'RESUME';
                DOMElements.comboCallout.textContent = 'PAUSED';
            } else {
                DOMElements.startBtn.querySelector('i').setAttribute('data-lucide', 'play');
                DOMElements.startBtn.querySelector('span').textContent = 'START ROUNDS';
            }

            if (!isRunningOrPaused) {
                 DOMElements.currentRoundDisplay.textContent = '1';
                 DOMElements.phaseDisplay.textContent = 'Work';
            }

            DOMElements.phaseDisplay.textContent = state.isWorkPhase ? 'Work' : 'Rest';
            DOMElements.timerDisplay.style.color = state.isWorkPhase ? 'var(--work-color)' : 'var(--rest-color)';
            if (state.timeRemaining <= 10 && state.isWorkPhase) {
                DOMElements.timerDisplay.style.color = 'var(--warn-color)';
            }
            DOMElements.currentRoundDisplay.textContent = state.currentRound;

            lucide.createIcons();
        }

        function updateTimerDisplays() {
            DOMElements.timerDisplay.textContent = formatTime(state.timeRemaining);
            DOMElements.totalTimeDisplay.textContent = `Total Remaining: ${formatTime(state.totalTimeRemaining)}`;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                DOMElements.fullscreenIcon.setAttribute('data-lucide', 'minimize');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    DOMElements.fullscreenIcon.setAttribute('data-lucide', 'maximize');
                }
            }
            lucide.createIcons();
        }

        // --- VISUAL EFFECTS ---
        function launchConfetti() {
            const container = document.getElementById('confetti-container');
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 90%, 70%)`;
                confetti.style.animationDelay = `${Math.random() * 2}s`;
                confetti.style.animationDuration = `${2 + Math.random() * 3}s`;
                container.appendChild(confetti);
                setTimeout(() => confetti.remove(), 5000);
            }
        }
        
        // --- INITIALIZATION ---
        function initialize() {
            updateConfig();
            updateUIForState();
            initializeSounds();

            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
            loadVoices();

            DOMElements.startBtn.addEventListener('click', startTimer);
            DOMElements.pauseBtn.addEventListener('click', pauseTimer);
            DOMElements.resetBtn.addEventListener('click', resetTimer);
            DOMElements.fullscreenBtn.addEventListener('click', toggleFullscreen);

            [DOMElements.roundDurationInput, DOMElements.restDurationInput, DOMElements.numRoundsInput,
             DOMElements.comboLengthSlider, DOMElements.comboDifficultySlider, DOMElements.moveComplexitySlider]
             .forEach(el => el.addEventListener('input', updateConfig));
            
            DOMElements.comboRepetitionsSelect.addEventListener('change', updateConfig);
            DOMElements.voiceVolumeSlider.addEventListener('input', updateVoiceVolume);

            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && Tone.context.state !== 'running') {
                    Tone.context.resume();
                }
            });

            lucide.createIcons();
        }
        
        initialize();
    });
    </script>
</body>
</html>
