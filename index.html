<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fight Me</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible+Next:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Atkinson Hyperlegible Next"', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

    <style>
        :root {
            --background-color: #0c1a2c; /* Dark Blue/Slate */
            --surface-color: #1a2a3c;   /* Slightly lighter surface */
            --accent-color: #f59e0b;      /* Amber */
            --text-color: #ffffffde;
            --work-color: #f59e0b;      
            --rest-color: #10b981;      
            --warn-color: #fcd34d;      
        }
        body {
            font-family: 'Atkinson Hyperlegible Next', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        #timer-display {
            font-size: clamp(3.5rem, 18vw, 9rem); 
            line-height: 1;
            font-weight: 900;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.2); 
            transition: text-shadow 0.5s ease, color 0.5s ease;
            text-align: center;
            letter-spacing: -0.05em;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--surface-color); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Style the select dropdown */
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25rem 1.25rem;
        }
        
        /* Volume Slider Customization */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent-color);
            cursor: pointer;
            border-radius: 50%;
            margin-top: -5px; 
            box-shadow: 0 0 5px rgba(245, 158, 11, 0.6);
            transition: background 0.2s;
        }
        input[type=range]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: var(--accent-color);
            cursor: pointer;
            border-radius: 50%;
            border: none;
            box-shadow: 0 0 5px rgba(245, 158, 11, 0.6);
            transition: background 0.2s;
        }
        input[type=range]::-webkit-slider-runnable-track {
            height: 4px;
            background: #475569;
            border-radius: 2px;
        }
        input[type=range]::-moz-range-track {
            height: 4px;
            background: #475569;
            border-radius: 2px;
        }

        /* Confetti Container Styling */
        #confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 60;
        }

        /* Basic Confetti Particle Style (CSS only for simplicity) */
        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--accent-color);
            opacity: 0;
            animation: pop 2.5s ease-out forwards;
        }

        @keyframes pop {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0.5; }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.25.0"
  }
}
</script>
</head>
<body class="min-h-screen flex items-center justify-center p-4 font-sans">

    <div id="confetti-container"></div>
    
    <div id="app" class="w-full max-w-sm sm:max-w-2xl bg-[--surface-color] shadow-2xl rounded-2xl p-6 sm:p-8 space-y-6 border border-slate-700">
        
        <header class="text-center flex justify-between items-center">
            <div class="w-1/5"></div> <div class="flex-grow">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-white tracking-wide">Fight Me</h1>
                <p id="workout-name" class="text-lg sm:text-xl text-slate-400 mt-1">A boxing training app</p>
            </div>
            <div class="w-1/5 flex justify-end">
                <button id="fullscreen-btn" onclick="toggleFullscreen()" title="Toggle Fullscreen"
                    class="p-2.5 bg-slate-700 hover:bg-slate-600 rounded-full text-white transition duration-150 active:scale-95">
                    <i data-lucide="maximize" class="w-6 h-6" id="fullscreen-icon"></i>
                </button>
            </div>
        </header>

        <div id="combo-callout" class="text-center text-2xl sm:text-3xl text-amber-500 font-extrabold min-h-[50px] p-3 bg-slate-700/50 rounded-lg shadow-inner flex items-center justify-center">
            <span class="text-slate-400 text-base">Press Start to begin training!</span>
        </div>

        <div class="text-center py-2 space-y-2">
            <div id="total-time-display" class="text-lg text-slate-400 font-semibold tabular-nums">
                Total Remaining: 00:00
            </div>
            <div id="timer-display" class="font-extrabold text-white tracking-tighter tabular-nums transition-colors duration-500">
                03:00
            </div>
        </div>

        <div class="space-y-6 max-h-[60vh] overflow-y-auto">
            <div id="config-card" class="bg-slate-700 rounded-xl p-4 sm:p-6 space-y-6 shadow-xl opacity-100 transition-opacity duration-300">
                
                <div class="space-y-3 border-b border-slate-600 pb-4">
                    <h3 class="text-xl font-bold text-amber-400">Timer Settings</h3>
                    <div class="grid grid-cols-3 gap-3 sm:gap-4">
                        <div class="space-y-1">
                            <label for="round-duration" class="text-xs font-semibold text-slate-300 block">Round Mins</label>
                            <input type="number" id="round-duration" value="3" min="1" oninput="updateConfig()"
                                class="w-full bg-slate-800 text-white p-2 rounded-lg border-2 border-slate-600 focus:border-amber-500 transition duration-150 text-center">
                        </div>
                        <div class="space-y-1">
                            <label for="rest-duration" class="text-xs font-semibold text-slate-300 block">Rest Mins</label>
                            <input type="number" id="rest-duration" value="1" min="0" oninput="updateConfig()"
                                class="w-full bg-slate-800 text-white p-2 rounded-lg border-2 border-slate-600 focus:border-amber-500 transition duration-150 text-center">
                        </div>
                        <div class="space-y-1">
                            <label for="num-rounds" class="text-xs font-semibold text-slate-300 block">Total Rounds</label>
                            <input type="number" id="num-rounds" value="5" min="1" oninput="updateConfig()"
                                class="w-full bg-slate-800 text-white p-2 rounded-lg border-2 border-slate-600 focus:border-amber-500 transition duration-150 text-center">
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="text-xl font-bold text-amber-400">Combo Logic Settings</h3>

                    <div class="space-y-2">
                        <label for="combo-length" class="text-sm font-semibold text-slate-300 block">1. Combo Length <span id="length-label" class="text-amber-300 ml-2 text-xs font-normal">Medium (1-4 Punches)</span></label>
                        <input type="range" id="combo-length-slider" min="0" max="2" value="1" step="1" oninput="updateConfig()"
                            class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <div class="flex justify-between text-xs text-slate-400 pt-1">
                            <span>Low</span><span>Medium</span><span>High</span>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label for="combo-difficulty" class="text-sm font-semibold text-slate-300 block">2. Combo Difficulty <span id="difficulty-label" class="text-amber-300 ml-2 text-xs font-normal">Medium (Some Same-Side)</span></label>
                        <input type="range" id="combo-difficulty-slider" min="0" max="2" value="1" step="1" oninput="updateConfig()"
                            class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <div class="flex justify-between text-xs text-slate-400 pt-1">
                            <span>Low</span><span>Medium</span><span>High</span>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label for="move-complexity" class="text-sm font-semibold text-slate-300 block">3. Move Complexity <span id="complexity-label" class="text-amber-300 ml-2 text-xs font-normal">Medium (Occasional Non-Punches)</span></label>
                        <input type="range" id="move-complexity-slider" min="0" max="2" value="1" step="1" oninput="updateConfig()"
                            class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <div class="flex justify-between text-xs text-slate-400 pt-1">
                            <span>Low</span><span>Medium</span><span>High</span>
                        </div>
                    </div>
                </div>

                <div class="space-y-4 border-t border-slate-600 pt-4">
                    <h3 class="text-xl font-bold text-amber-400">Audio & Control Settings</h3>
                    
                    <div class="grid grid-cols-2 gap-4"> 
                        <div class="space-y-1">
                            <label for="combo-repetitions-select" class="text-xs font-semibold text-slate-300 block">4. Combo Intensity</label>
                            <select id="combo-repetitions-select" onchange="updateConfig()"
                                class="w-full bg-slate-800 text-white p-2 rounded-lg border-2 border-slate-600 focus:border-amber-500 transition duration-150 appearance-none pr-10">
                                <option value="1">Low (1x Repetition)</option>
                                <option value="2">Medium (2x Repetitions)</option>
                                <option value="3" selected>High (3x Repetitions)</option>
                            </select>
                        </div>

                        <div class="space-y-1">
                            <label for="voice-volume-slider" class="text-xs font-semibold text-slate-300 block">5. Voice Volume (<span id="voice-volume-label">100%</span>)</label>
                            <input type="range" id="voice-volume-slider" min="0" max="1" step="0.05" value="1" oninput="updateVoiceVolume()"
                                class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        </div>
                    </div> 
                    <div id="controls" class="flex flex-col space-y-3 pt-2">
                        <button id="start-btn" onclick="startTimer()" 
                            class="w-full p-4 bg-amber-500 hover:bg-amber-600 text-slate-900 text-xl font-bold rounded-xl shadow-lg transition duration-150 active:scale-95 flex items-center justify-center space-x-2">
                            <i data-lucide="play" class="w-6 h-6"></i>
                            <span>START ROUNDS</span>
                        </button>
                        <div class="flex space-x-3">
                            <button id="pause-btn" onclick="pauseTimer()" disabled 
                                class="flex-grow p-3 bg-slate-600 hover:bg-slate-500 text-white font-semibold rounded-xl transition duration-150 active:scale-95 opacity-50 cursor-not-allowed flex items-center justify-center space-x-2">
                                <i data-lucide="pause" class="w-5 h-5"></i>
                                <span>Pause</span>
                            </button>
                            <button id="reset-btn" onclick="resetTimer()" 
                                class="flex-grow p-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition duration-150 active:scale-95 flex items-center justify-center space-x-2">
                                <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                                <span>Reset</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="info-card" class="bg-slate-700 rounded-xl p-4 sm:p-6 space-y-4 shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none absolute inset-0 sm:relative sm:inset-auto sm:pointer-events-auto">
                
                <div class="flex justify-between items-center pb-2 border-b border-slate-600">
                    <div class="text-xl font-bold text-white">Round Progress</div>
                    <div class="text-lg font-semibold text-amber-300">Round <span id="current-round">1</span> / <span id="total-rounds">5</span></div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="p-4 bg-slate-800 rounded-lg">
                        <div class="text-xs font-semibold text-slate-400 uppercase">Phase</div>
                        <div id="phase-display" class="text-2xl font-extrabold text-amber-400 mt-1">Work</div>
                    </div>
                    <div class="p-4 bg-slate-800 rounded-lg">
                        <div class="text-xs font-semibold text-slate-400 uppercase">Next Callout In</div>
                        <div id="combo-countdown" class="text-2xl font-extrabold text-white mt-1 tabular-nums">0s</div>
                    </div>
                </div>

                <div class="pt-2 border-t border-slate-600">
                    <h4 class="text-lg font-bold text-slate-300 mb-2">Last Callout:</h4>
                    <p id="last-combo-display" class="text-base text-slate-400 font-mono italic">--</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenAI, Modality } from "@google/genai";

        // --- Gemini AI and Audio Setup ---
        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
        const outputAudioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
        const outputNode = outputAudioContext.createGain();
        outputNode.connect(outputAudioContext.destination);
        let currentAudioSource = null;


        // --- Global state and configuration ---
        const config = {
            roundDuration: 3,       // in minutes
            restDuration: 1,        // in minutes
            numRounds: 5,           // total rounds
            comboLength: 2,         // 0: low (1-3), 1: medium (1-4), 2: high (1-5)
            comboDifficulty: 1,     // 0: low (always alternate), 1: medium (some same-side), 2: high (frequent same-side)
            moveComplexity: 1,      // 0: low (only punches), 1: medium (occasional non-punches), 2: high (frequent non-punches)
            comboRepetitions: 3,    // 1, 2, or 3 times the combo is repeated
            voiceVolume: 1,         // 0 to 1
            
            timerRunning: false,
            roundRemaining: 0,      // in seconds
            totalElapsed: 0,        // total seconds elapsed
            currentRound: 1,        // current round number
            currentPhase: 'setup',  // 'setup', 'work', 'rest', 'finished'
            comboTime: 4000,        // interval for combo generation in ms
            comboIntervalMin: 1000, // Min time to next combo (1 second)
            
            // UI References
            timerDisplay: document.getElementById('timer-display'),
            phaseDisplay: document.getElementById('phase-display'),
            comboCallout: document.getElementById('combo-callout'),
            lastComboDisplay: document.getElementById('last-combo-display'),
            controls: document.getElementById('controls'),
            startBtn: document.getElementById('start-btn'),
            pauseBtn: document.getElementById('pause-btn'),
            resetBtn: document.getElementById('reset-btn'),
            configCard: document.getElementById('config-card'),
            infoCard: document.getElementById('info-card'),
        };

        // Timer intervals and timeouts
        let timerInterval = null;
        let comboInterval = null;
        let warningTimeout = null;

        // Punch Mapping
        const punchMoves = {
            '1': { call: 'one', side: 'lead', type: 'punch' },
            '2': { call: 'two', side: 'rear', type: 'punch' },
            '3': { call: 'three', side: 'lead', type: 'punch' },
            '4': { call: 'four', side: 'rear', type: 'punch' },
            '5': { call: 'five', side: 'lead', type: 'punch' },
            '6': { call: 'six', side: 'rear', type: 'punch' },
            'D': { call: 'slip', side: 'lead', type: 'non-punch' },
            'DD': { call: 'roll', side: 'rear', type: 'non-punch' },
            'P': { call: 'switch', side: 'lead', type: 'non-punch' },
            'B': { call: 'feint', side: 'lead', type: 'non-punch' },
        };

        const allPunches = ['1', '2', '3', '4', '5', '6'];
        const nonPunchMoves = ['D', 'DD', 'P', 'B'];

        let lastMoveSide = null;

        // Tone.js setup
        let workBeep, restBeep, finalBeep;
        try {
            workBeep = new Tone.MembraneSynth().toDestination();
            restBeep = new Tone.MembraneSynth().toDestination();
            finalBeep = new Tone.MembraneSynth().toDestination();
            workBeep.volume.value = -12;
            restBeep.volume.value = -12;
            finalBeep.volume.value = -10;
        } catch (e) {
            console.error("Tone.js initialization failed.", e);
        }


        // --- Audio Decoding Helper Functions ---
        function decode(base64) {
          const binaryString = atob(base64);
          const len = binaryString.length;
          const bytes = new Uint8Array(len);
          for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          return bytes;
        }

        async function decodeAudioData(data, ctx, sampleRate, numChannels) {
          const dataInt16 = new Int16Array(data.buffer);
          const frameCount = dataInt16.length / numChannels;
          const buffer = ctx.createBuffer(numChannels, frameCount, sampleRate);
          for (let channel = 0; channel < numChannels; channel++) {
            const channelData = buffer.getChannelData(channel);
            for (let i = 0; i < frameCount; i++) {
              channelData[i] = dataInt16[i * numChannels + channel] / 32768.0;
            }
          }
          return buffer;
        }


        // --- Utility Functions ---
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        function updateUI() {
            config.timerDisplay.textContent = formatTime(config.roundRemaining);
            config.phaseDisplay.textContent = config.currentPhase.charAt(0).toUpperCase() + config.currentPhase.slice(1);
            document.getElementById('current-round').textContent = String(config.currentRound);
            document.getElementById('total-rounds').textContent = String(config.numRounds);

            const totalRemainingSeconds = (config.numRounds - config.currentRound) * (config.roundDuration * 60 + config.restDuration * 60) + config.roundRemaining;
            document.getElementById('total-time-display').textContent = `Total Remaining: ${formatTime(totalRemainingSeconds)}`;

            if (config.currentPhase === 'work') {
                document.body.style.backgroundColor = 'var(--work-color)';
                config.timerDisplay.style.color = 'var(--background-color)';
            } else if (config.currentPhase === 'rest') {
                document.body.style.backgroundColor = 'var(--rest-color)';
                config.timerDisplay.style.color = 'var(--background-color)';
            } else {
                document.body.style.backgroundColor = 'var(--background-color)';
                config.timerDisplay.style.color = 'white';
            }

            const isFinished = config.currentPhase === 'finished';
            const isRunning = config.timerRunning;

            config.startBtn.disabled = isRunning || isFinished;
            config.pauseBtn.disabled = !isRunning || isFinished;

            config.startBtn.querySelector('span').textContent = isRunning ? 'RUNNING' : (isFinished ? 'FINISHED' : 'START ROUNDS');
            config.startBtn.classList.toggle('bg-gray-500', isRunning || isFinished);
            config.startBtn.classList.toggle('bg-amber-500', !isRunning && !isFinished);
            config.startBtn.classList.toggle('bg-green-500', isFinished);

            config.pauseBtn.classList.toggle('opacity-100', isRunning);
            config.pauseBtn.classList.toggle('opacity-50', !isRunning);
            config.pauseBtn.classList.toggle('cursor-pointer', isRunning);
            config.pauseBtn.classList.toggle('cursor-not-allowed', !isRunning);

            config.configCard.classList.toggle('opacity-0', isRunning || isFinished);
            config.configCard.classList.toggle('pointer-events-none', isRunning || isFinished);
            
            config.infoCard.classList.toggle('opacity-100', isRunning || isFinished);
            config.infoCard.classList.toggle('pointer-events-auto', isRunning || isFinished);
        }

        function updateConfig() {
            config.roundDuration = parseInt(document.getElementById('round-duration').value) || 3;
            config.restDuration = parseInt(document.getElementById('rest-duration').value) || 1;
            config.numRounds = parseInt(document.getElementById('num-rounds').value) || 5;
            config.comboLength = parseInt(document.getElementById('combo-length-slider').value) || 1;
            config.comboDifficulty = parseInt(document.getElementById('combo-difficulty-slider').value) || 1;
            config.moveComplexity = parseInt(document.getElementById('move-complexity-slider').value) || 1;
            config.comboRepetitions = parseInt(document.getElementById('combo-repetitions-select').value) || 3;
            
            const lengthLabels = ['Short (1-2 Punches)', 'Medium (1-4 Punches)', 'Long (1-6 Punches)'];
            document.getElementById('length-label').textContent = lengthLabels[config.comboLength];
            
            const difficultyLabels = ['Strict (Always Alternate)', 'Standard (Some Same-Side)', 'Complex (Frequent Same-Side)'];
            document.getElementById('difficulty-label').textContent = difficultyLabels[config.comboDifficulty];

            const complexityLabels = ['Basic (Punches Only)', 'Intermediate (Occasional Non-Punches)', 'Advanced (Frequent Non-Punches)'];
            document.getElementById('complexity-label').textContent = complexityLabels[config.moveComplexity];

            if (config.currentPhase === 'setup' || config.currentPhase === 'finished') {
                config.roundRemaining = config.roundDuration * 60;
                config.timerDisplay.textContent = formatTime(config.roundRemaining);
                document.getElementById('total-rounds').textContent = String(config.numRounds);
                updateUI();
            }
        }

        function updateVoiceVolume() {
            const volume = parseFloat(document.getElementById('voice-volume-slider').value);
            config.voiceVolume = volume;
            outputNode.gain.value = volume;
            document.getElementById('voice-volume-label').textContent = `${Math.round(volume * 100)}%`;
        }

        // --- Audio Functions ---
        async function speakCallout(phrase) {
            if (config.voiceVolume === 0) return;

            // Stop any currently playing audio
            if (currentAudioSource) {
                currentAudioSource.stop();
                currentAudioSource = null;
            }

            try {
                const fullPrompt = `Say with an assertive and encouraging tone: ${phrase}`;
                const response = await ai.models.generateContent({
                    model: "gemini-2.5-flash-preview-tts",
                    contents: [{ parts: [{ text: fullPrompt }] }],
                    config: {
                        responseModalities: [Modality.AUDIO],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: 'Kore' }, // A strong, clear female voice
                            },
                        },
                    },
                });
                
                const base64Audio = response.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (base64Audio) {
                    const audioBuffer = await decodeAudioData(
                        decode(base64Audio),
                        outputAudioContext,
                        24000,
                        1,
                    );
                    const source = outputAudioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(outputNode);
                    source.start();
                    
                    currentAudioSource = source;
                    source.onended = () => {
                        currentAudioSource = null;
                    };
                }
            } catch (error) {
                console.error("Gemini TTS Error:", error);
                config.comboCallout.innerHTML = `<span class="text-red-400 text-base">Audio Error</span>`;
            }
        }

        function playBeep(type) {
            if (!Tone || !workBeep) return;
            Tone.Master.volume.value = -10;

            if (type === 'work') workBeep.triggerAttackRelease('C4', '8n');
            else if (type === 'rest') restBeep.triggerAttackRelease('G3', '8n');
            else if (type === 'final') finalBeep.triggerAttackRelease('C5', '4n');
            else if (type === 'end') {
                finalBeep.triggerAttackRelease('C4', '8n');
                setTimeout(() => finalBeep.triggerAttackRelease('C5', '8n'), 150);
            }
        }


        // --- Combo Generation Logic ---
        function selectRandomMove(currentCombo, lengthLimit, difficultyLevel, complexityLevel) {
            let availableMoves = [...allPunches];
            if (complexityLevel > 0 && Math.random() < complexityLevel * 0.35) {
                availableMoves = availableMoves.concat(nonPunchMoves);
            }

            let nextMoveKey = null;
            let attempts = 0;
            while (nextMoveKey === null && attempts < 10) {
                const candidateKey = availableMoves[Math.floor(Math.random() * availableMoves.length)];
                const candidateMove = punchMoves[candidateKey];
                if (!candidateMove) {
                    attempts++;
                    continue;
                }
                if (currentCombo.length >= lengthLimit - 1 && candidateMove.type === 'punch' && Math.random() < 0.5) {
                    attempts++;
                    continue;
                }
                if (lastMoveSide === candidateMove.side) {
                    const rejectionChances = [1.0, 0.7, 0.3];
                    if (Math.random() < rejectionChances[difficultyLevel]) {
                        attempts++;
                        continue;
                    }
                }
                nextMoveKey = candidateKey;
            }

            if (nextMoveKey === null) {
                nextMoveKey = Math.random() > 0.5 ? '1' : '2';
            }

            lastMoveSide = punchMoves[nextMoveKey].side;
            return { key: nextMoveKey, call: punchMoves[nextMoveKey].call };
        }

        async function generateCombo() {
            const lengthMap = [2, 4, 6];
            const lengthLimit = lengthMap[config.comboLength];
            const comboLength = Math.floor(Math.random() * lengthLimit) + 1;
            const repetitions = config.comboRepetitions;

            let comboKeys = [];
            let comboCallouts = [];
            lastMoveSide = null;

            for (let i = 0; i < comboLength; i++) {
                const move = selectRandomMove(comboKeys, comboLength, config.comboDifficulty, config.moveComplexity);
                comboKeys.push(move.key);
                comboCallouts.push(move.call);
            }

            const comboSpokenPhrase = comboCallouts.join(', ');
            const repeatedSpoken = Array(repetitions).fill(comboSpokenPhrase).join('. ');
            
            const minComboTime = (comboLength * repetitions * 0.8 + 1) * 1000;
            const maxComboTime = minComboTime + 3000;
            config.comboTime = Math.max(config.comboIntervalMin, Math.floor(Math.random() * (maxComboTime - minComboTime + 1)) + minComboTime);
            
            config.comboCallout.innerHTML = `<span class="text-3xl sm:text-4xl text-white font-extrabold">${comboKeys.join(' - ')}</span>`;
            config.lastComboDisplay.textContent = `(${comboKeys.length} moves x ${repetitions} reps) -> ${repeatedSpoken}`;
            
            await speakCallout(repeatedSpoken);
            
            updateComboCountdown(config.comboTime);
            return config.comboTime;
        }

        async function comboLoop() {
            if (!config.timerRunning || config.currentPhase !== 'work') return;
            const delayTime = await generateCombo();
            if (config.timerRunning && config.currentPhase === 'work') {
                comboInterval = window.setTimeout(comboLoop, delayTime);
            }
        }

        function updateComboCountdown(timeRemaining) {
            const countdownEl = document.getElementById('combo-countdown');
            if (countdownEl.interval) clearInterval(countdownEl.interval);
            let remainingSeconds = Math.ceil(timeRemaining / 1000);
            countdownEl.textContent = `${remainingSeconds}s`;
            if (remainingSeconds > 0) {
                countdownEl.interval = setInterval(() => {
                    remainingSeconds--;
                    countdownEl.textContent = `${remainingSeconds}s`;
                    if (remainingSeconds <= 0) clearInterval(countdownEl.interval);
                }, 1000);
            }
        }

        // --- Timer Core Logic ---
        function startRound(phase) {
            config.currentPhase = phase;
            config.timerRunning = true;
            
            if (phase === 'work') {
                config.roundRemaining = config.roundDuration * 60;
                config.comboCallout.innerHTML = `<span class="text-slate-400 text-base">Get ready to work!</span>`;
                // Don't await this, let it run in the background
                comboLoop();
            } else if (phase === 'rest') {
                config.roundRemaining = config.restDuration * 60;
                config.comboCallout.innerHTML = `<span class="text-emerald-400">REST! Round ${config.currentRound + 1} next.</span>`;
                if (comboInterval) clearTimeout(comboInterval);
            } else if (phase === 'finished') {
                endWorkout();
                return;
            }

            if (warningTimeout) clearTimeout(warningTimeout);
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = window.setInterval(updateTimer, 1000);
            updateUI();
        }

        function updateTimer() {
            if (!config.timerRunning || config.roundRemaining <= 0) {
                handlePhaseEnd();
                return;
            }

            config.roundRemaining--;
            config.totalElapsed++;
            
            if (config.roundRemaining === 10) {
                playBeep('final');
                config.timerDisplay.style.color = 'var(--warn-color)';
                document.body.style.backgroundColor = 'var(--warn-color)';
            }

            updateUI();
        }

        function handlePhaseEnd() {
            if (timerInterval) clearInterval(timerInterval);
            if (comboInterval) clearTimeout(comboInterval);
            if (warningTimeout) clearTimeout(warningTimeout);
            config.timerRunning = false;
            playBeep('end');
            
            if (config.currentPhase === 'work') {
                config.currentRound++;
                if (config.currentRound > config.numRounds) {
                    startRound('finished');
                } else {
                    startRound(config.restDuration > 0 ? 'rest' : 'work');
                }
            } else if (config.currentPhase === 'rest') {
                startRound('work');
            }
        }

        function endWorkout() {
            config.currentPhase = 'finished';
            config.roundRemaining = 0;
            config.comboCallout.innerHTML = `<span class="text-green-400">WORKOUT COMPLETE!</span>`;
            config.timerDisplay.textContent = formatTime(0);
            triggerConfetti();
            updateUI();
        }


        // --- User Control Functions ---
        function startTimer() {
            if (!config.timerRunning && config.roundRemaining > 0) {
                if (Tone.context.state !== 'running') Tone.context.resume();
                if (outputAudioContext.state !== 'running') outputAudioContext.resume();

                if (config.currentPhase === 'setup') {
                    startRound('work');
                } else {
                    config.timerRunning = true;
                    if (config.currentPhase === 'work') {
                        comboInterval = window.setTimeout(comboLoop, config.comboIntervalMin);
                    }
                    if (timerInterval) clearInterval(timerInterval);
                    timerInterval = window.setInterval(updateTimer, 1000);
                }
                updateUI();
            }
        }

        function pauseTimer() {
            if (config.timerRunning) {
                config.timerRunning = false;
                if (timerInterval) clearInterval(timerInterval);
                if (comboInterval) clearTimeout(comboInterval);
                if (warningTimeout) clearTimeout(warningTimeout);
                
                if (currentAudioSource) {
                    currentAudioSource.stop();
                    currentAudioSource = null;
                }

                config.comboCallout.innerHTML = `<span class="text-red-400">PAUSED</span>`;
                updateUI();
            }
        }

        function resetTimer() {
            config.timerRunning = false;
            if (timerInterval) clearInterval(timerInterval);
            if (comboInterval) clearTimeout(comboInterval);
            if (warningTimeout) clearTimeout(warningTimeout);
            if (currentAudioSource) {
                currentAudioSource.stop();
                currentAudioSource = null;
            }

            config.currentRound = 1;
            config.totalElapsed = 0;
            config.currentPhase = 'setup';
            config.roundRemaining = config.roundDuration * 60;
            
            config.timerDisplay.style.color = 'white';
            document.body.style.backgroundColor = 'var(--background-color)';
            config.comboCallout.innerHTML = `<span class="text-slate-400 text-base">Press Start to begin training!</span>`;
            config.lastComboDisplay.textContent = '--';
            updateUI();
        }


        // --- Fullscreen and Confetti ---
        function toggleFullscreen() {
            const doc = document.documentElement;
            const fullscreenIcon = document.getElementById('fullscreen-icon');
            if (!document.fullscreenElement) {
                doc.requestFullscreen?.();
                fullscreenIcon.setAttribute('data-lucide', 'minimize');
            } else {
                document.exitFullscreen?.();
                fullscreenIcon.setAttribute('data-lucide', 'maximize');
            }
            setTimeout(() => lucide.createIcons(), 100);
        }

        function triggerConfetti() {
            const container = document.getElementById('confetti-container');
            for (let i = 0; i < 50; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.left = `${Math.random() * 100}vw`;
                piece.style.top = `-${Math.random() * 20}vh`;
                piece.style.backgroundColor = ['#f59e0b', '#fcd34d', '#ffffff'][Math.floor(Math.random() * 3)];
                piece.style.transform = `rotate(${Math.random() * 360}deg)`;
                piece.style.animationDelay = `${Math.random() * 0.5}s`;
                piece.style.animationDuration = `${2 + Math.random() * 1.5}s`;
                container.appendChild(piece);
                piece.addEventListener('animationend', () => piece.remove());
            }
        }

        // --- Initialization ---
        window.onload = () => {
            updateConfig();
            updateVoiceVolume();

            document.addEventListener('keydown', (e) => {
                if (e.key === 'F11' || (e.key === 'f' && document.activeElement?.tagName !== 'INPUT')) {
                    e.preventDefault();
                    toggleFullscreen();
                }
            });
            
            lucide.createIcons(); 
        };

        // Make functions accessible from HTML onclick attributes
        window.startTimer = startTimer;
        window.pauseTimer = pauseTimer;
        window.resetTimer = resetTimer;
        window.updateConfig = updateConfig;
        window.updateVoiceVolume = updateVoiceVolume;
        window.toggleFullscreen = toggleFullscreen;
    </script>
</body>
</html>
